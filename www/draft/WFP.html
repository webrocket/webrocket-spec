<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.6">
<title>WFP - WebSockets Frontend Protocol</title>
<link rel="stylesheet" href="../style/asciidoc.css" type="text/css">
<link rel="stylesheet" href="../style/pygments.css" type="text/css">
<script type="text/javascript" src="./asciidoc.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>WFP - WebSockets Frontend Protocol</h1>
<span id="author">Krzysztof Kowalik</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:chris@nu7hat.ch">chris@nu7hat.ch</a>&gt;</span><br>
<span id="revnumber">version 0.1,</span>
<span id="revdate">December 2011</span>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
<strong>Latest Editor&#8217;s Draft</strong>: <a href="http://rfc.webrocket.io/draft/WFP.html">http://rfc.webrocket.io/draft/WFP.html</a>
</p>
</li>
<li>
<p>
<strong>Status</strong>: Draft
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_abstract">Abstract</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <strong>WebSockets Frontend Protocol</strong> (<strong>WFP</strong>) is a transport layer protocol
for exchanging messages between Browsers and the Frontend WebSockets
Server implemented by the <a href="#WR">WebRocket</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_language">Language</h2>
<div class="sectionbody">
<div class="paragraph"><p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this
document are to be interpreted as described in <a href="#RFC2119">RFC 2119</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_goals">Goals</h2>
<div class="sectionbody">
<div class="paragraph"><p>The purpose of the protocol is to allow for bidirectional, evented
communication between Browsers and Frontend WebSockets Server over
the <a href="#WSP">WebSockets Protocol</a> using the <a href="#WSA">HTML5 WebSockets API</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_generalized_architecture">Generalized architecture</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Frontend WebSockets Server handles communication with the Clients
(Browsers) over the <a href="#WSP">HTML5&#8217;s WebSockets Protocol</a>. Its endpoint
is combined up of a number of parts:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>[scheme]://[host]:[port]/[vhost]</pre>
</div></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
<em>scheme</em>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Will be <em>ws</em> for a normal connection and <em>wss</em> for a secure.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>host</em>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        There is bound the server.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>port</em>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The port to connect to.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>vhost</em>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The virtual host to connect to.
</p>
</td>
</tr>
</table></div>
<div class="literalblock">
<div class="title">Example</div>
<div class="content monospaced">
<pre>ws://webrocket.io/echo</pre>
</div></div>
<div class="sect2">
<h3 id="_events">Events</h3>
<div class="paragraph"><p>The protocol implemented by <a href="#WR">WebRocket</a> defines two kinds of events:
<a href="#client-events"><em>client</em></a> and <a href="#server-events"><em>server</em></a> specific.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="client-events">Client Events (WebRocket &#8594; Cient)</h2>
<div class="sectionbody">
<div class="paragraph" id="client-custom-event-format"><p>All client event messages MUST have the following <a href="#JSON">JSON</a>-encoded
payload format:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;eventName&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// ... parameters ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Parameter keys SHOULD be defined as camel-cased strings, to keep
compliance with the JavaScript coding style guidelines.</p></div>
<div class="paragraph"><p>Two groups of <em>client</em> specific events can be distinguished:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>System events</em>
</dt>
<dd>
<p>
                Events triggered automatically by the Frontend WebSockets
                Server and sent to the Client. System event names MUST be
                prefixed with double underscore (eg. <em>__connected</em>).
</p>
</dd>
<dt class="hdlist1">
<em>Custom events</em>
</dt>
<dd>
<p>
                User-defined events triggered by Backend Applications or other
                connected Clients. Custom events always contains the <span class="monospaced">channel</span>
                parameter in its payload.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="../images/icons/important.png" alt="Important">
</td>
<td class="content">The <em>event-name</em> MUST be prefixed with double underscore for
        the <em>system</em> events, and SHALL NOT use such prefix for the <em>custom</em>
        user-defined events.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_connection_established">Connection established</h3>
<div class="paragraph"><p>When the connection is successfully established the Server sends an event
to confirm that situation with the Client. Message&#8217;s payload MUST contain
unique identifier of the current session.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__connected&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;sid&quot;</span><span class="o">:</span> <span class="s2">&quot;session-id&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>sid</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        An unique identifier of the current session.
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect2">
<h3 id="client-succ-auth">Successfull authentication</h3>
<div class="paragraph"><p>When connected Client has been successfully <a href="#server-auth">authenticated</a>
the Server sends an event to confirm that situation. Message&#8217;s payload
 MAY contain additional information about the authenticated session.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__authenticated&quot;</span><span class="o">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="client-confirm-sub">Confirmed subscription</h3>
<div class="paragraph"><p>When connected Client has successfully <a href="#server-subscribe">subscribed</a>
to the specified channel the Server sends an event to confirm that
situation. Message&#8217;s payload MUST contain the name of the subscribed
channel.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__subscribed&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The name of the subscribed channel.
</p>
</td>
</tr>
</table></div>
<div class="sect3">
<h4 id="client-confirm-priv-sub">Private channel subscription</h4>
<div class="paragraph"><p>If subscribed channel is a <em>Private Channel</em> then message&#8217;s payload MAY
additionaly contain information about the Client permissions.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__subscribed&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;permission&quot;</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the subscribed channel.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>permission</em> [<span class="monospaced">int</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The numeric value of the client permissions.
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect3">
<h4 id="client-confirm-presence-sub">Presence channel subscription</h4>
<div class="paragraph"><p>The <em>Presence channel</em> is a special kind of channel, which keeps track of
all Clients subscribed on it and shares that information across all other
subscribers. In that case, the message&#8217;s payload MUST contain list of
subscribers' records with session identifier. The subscribers' records
MAY additionally contain custom data about related with particular
subscriber.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__subscribed&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subscribers&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;sid&quot;</span><span class="o">:</span> <span class="s2">&quot;session-id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
                    <span class="c1">// ... custom information ...</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the subscribed channel.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>subscribers</em> [<span class="monospaced">array</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        List of active subscribers (clients present on this channel).
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>subscribers.sid</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The Client&#8217;s session identifier.
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect3">
<h4 id="client-presence-activity">Presence channel&#8217;s subscribers acivity</h4>
<div class="paragraph"><p>Subscribers activity on the presence channel SHALL be populated across
all other subscribers using special events triggered when the Client
joined and left the channel.</p></div>
<div class="sect4">
<h5 id="client-onjoin">On join</h5>
<div class="paragraph"><p>When new subscriber joined the presence channel the triggered event
MUST contain the subscriber&#8217;s session identifier, and MAY contain
additional, custom information related to the subscriber.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__memberJoined&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;sid&quot;</span><span class="o">:</span> <span class="s2">&quot;session-id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
           <span class="c1">// ... custom information ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>sid</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The Client&#8217;s session identifier.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>data</em> [<span class="monospaced">object</span>] optional
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The data passed by the client while starting a subscription.
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect4">
<h5 id="client-onleave">On leave</h5>
<div class="paragraph"><p>When connected subscriber left a channel, the triggered event
MUST contain the subscriber&#8217;s session identifier.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__memberLeft&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;sid&quot;</span><span class="o">:</span> <span class="s2">&quot;session-id&quot;</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
           <span class="c1">// ... custom information ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>sid</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The Client&#8217;s session identifier.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>data</em> [<span class="monospaced">object</span>] optional
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The data passsed by the Client while terminating a subscription.
</p>
</td>
</tr>
</table></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-confirm-unsub">Confirmed unsubscription</h3>
<div class="paragraph"><p>When connected Client has successfully <a href="#server-unsubscribe">unusubscribed</a>
from the specified channel the Server sends an event to confirm that
situation. Message&#8217;s payload MUST contain the name of the unsubscribed
channel.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__unsubscribed&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The name of the unsubscribed channel.
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect2">
<h3 id="client-heartbeat">Heartbeat</h3>
<div class="paragraph"><p>Server periodically sends a heartbeat message to ensure that the
Client is still connected and ready to receive the message. The
Client SHALL immedietely respond with the <a href="#server-pong">pong</a>
message.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__ping&quot;</span><span class="o">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="client-closed">Closed connection confirmation</h3>
<div class="paragraph"><p>When the Client <a href="#server-close">safely closes connection</a> the Server
MUST sends an confirmation message to the client. The confirmation
message SHALL contain the identifier of the closed session.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__closed&quot;</span><span class="o">:</span> <span class="p">{</span>
         <span class="s2">&quot;sid&quot;</span><span class="o">:</span> <span class="s2">&quot;session-id&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>sid</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The Client&#8217;s session identifier.
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect2">
<h3 id="client-error">Error notification</h3>
<div class="paragraph"><p>When problem encountered the Server MUST send apropriate, explicit
information to concerned client. The message&#8217;s payload MUST contain
the numeric error code and short human readable explanation.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;__error&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="o">:</span> <span class="mi">402</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="s2">&quot;Unauthorized&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>code</em> [<span class="monospaced">int</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The numeric error code. Status codes are inspired by the HTTP
        error codes.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>status</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Error status explanation.
</p>
</td>
</tr>
</table></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-events">Server Events (Client &#8594; WebRocket)</h2>
<div class="sectionbody">
<div class="paragraph"><p>The format of all server events implements the same <a href="#JSON">JSON</a>-encoded
protocol as is implemented by the <a href="#client-events">client events</a>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;eventName&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="c1">// ... data ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Parameters conventions and requirements are also the same as in
the <a href="#client-events">client events</a> specification.</p></div>
<div class="sect2">
<h3 id="server-auth">Authentication</h3>
<div class="paragraph"><p>When the Client wants to authenticate using a single access token,
MUST send an authentication message. When authentication operation
succeed an <a href="#client-succ-auth">authentication confirmation event</a>
MUST be sent from the Server to this Client.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;auth&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;token&quot;</span><span class="o">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>token</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        A <strong>Single Access Token</strong> obtained by the Backend Worker.
</p>
</td>
</tr>
</table></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Client sends the <em>authenticate</em> message
</p>
</li>
<li>
<p>
Server MUST validate it and authenticate the session
</p>
</li>
<li>
<p>
Server MUST notify a Client about successfull authentication
  with the <a href="#client-succ-auth"><em>__authenticated</em></a> event.
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
<li>
<p>
<a href="#err-unauth">Unauthorized</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="server-subscribe">Subscribing a channel</h3>
<div class="paragraph"><p>When the Client wants to subscribe to specified channel MUST send
an subscription request message. When subscribe operation succeed
an <a href="#client-confirm-sub">subscription confirmation event</a> MUST be
sent from the Server to this Client.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;subscribe&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// ... user specific data ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the channel we want to subscribe to.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>data</em> [<span class="monospaced">object</span>] optional
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        User specific information, used only by the presence channels.
</p>
</td>
</tr>
</table></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Client sends the <em>subscribe</em> message
</p>
</li>
<li>
<p>
Server MUST validate and store specified subscription
</p>
</li>
<li>
<p>
If subscribing a Presence Channel, then all other subscribers
  SHALL get notified with the <a href="#client-onjoin"><em>__heJoined</em></a> event.
</p>
</li>
<li>
<p>
Server MUST notify a Client about successfull subscription
  with the <a href="#client-confirm-sub"><em>__subscribed</em></a> event.
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
<li>
<p>
<a href="#err-forbidden">Forbidden</a>
</p>
</li>
<li>
<p>
<a href="#err-channel-not-found">Channel not found</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="server-unsubscribe">Unsubscribing a channel</h3>
<div class="paragraph"><p>When the client wants to unsubscribe specified channel, MUST send an
unsubscription request message. When unsubscribe operation succeed
an <a href="#client-confirm-unsub">unsubscription confirmation event</a> MUST be
sent from the Server to this Client.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;unsubscribe&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// ... custom data ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the channel we want to subscribe to.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>data</em> [<span class="monospaced">object</span>] optional
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        User specific information, used only by the presence channels.
</p>
</td>
</tr>
</table></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Client sends the <em>unsubscribe</em> message
</p>
</li>
<li>
<p>
Server MUST validate and remove specified subscription
</p>
</li>
<li>
<p>
If unsubscribing a Presence Channel, then all other subscribers
  SHALL get notified with the <a href="#client-onleft"><em>__heLeft</em></a> event.
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
<li>
<p>
<a href="#err-forbidden">Forbidden</a>
</p>
</li>
<li>
<p>
<a href="#err-channel-not-found">Channel not found</a>
</p>
</li>
<li>
<p>
<a href="#err-not-subscribed">Not subscribed</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="server-broadcast">Broadcasting to the channel</h3>
<div class="paragraph"><p>When the connected Client (subscriber) wants to broadcast information
to all other subscribers of the specified channel, MUST send an broadcast
request.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;broadcast&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;chat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;event&quot;</span><span class="o">:</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trigger&quot;</span><span class="o">:</span> <span class="s2">&quot;chat/save_to_history&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// ... broadcasted parameters ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>channel</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the channel we want to subscribe to.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>event</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        This custom event will be triggered for all subscribers.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>trigger</em> [<span class="monospaced">string</span>] optional
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the Backend Application&#8217;s event to be asynchronously triggered.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>data</em> [<span class="monospaced">object</span>] optional
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The data to be passed to all subscribers.
</p>
</td>
</tr>
</table></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Client sends the <em>broadcast</em> message
</p>
</li>
<li>
<p>
Server SHALL validate it and MUST resend it to all subscribers
  of the specified channel.
</p>
</li>
<li>
<p>
Message MUST be re-composed to match the <a href="#client-custom-event-format">custom event message format</a>
</p>
</li>
<li>
<p>
If the <em>trigger</em> option is specified, server SHOULD trigger
  specified event on the Backend Application.
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
<li>
<p>
<a href="#err-forbidden">Forbidden</a>
</p>
</li>
<li>
<p>
<a href="#err-channel-not-found">Channel not found</a>
</p>
</li>
<li>
<p>
<a href="#err-not-subscribed">Not subscribed</a>
</p>
</li>
<li>
<p>
<a href="#err-service-unavail">Service unavailable</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="server-trigger">Triggering the backend app&#8217;s event</h3>
<div class="paragraph"><p>When the connected Client wants to trigger a Backend Application&#8217;s
event MUST send a trigger message.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;trigger&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;event&quot;</span><span class="o">:</span> <span class="s2">&quot;chat/save_and_broadcast&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// ... passed parameters ...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Client sends the <em>trigger</em> message
</p>
</li>
<li>
<p>
Server SHALL find free worker (Backend Application connection) using
  load ballance algorightm and send the event message
</p>
</li>
<li>
<p>
Server SHALL send a validated and re-composed message to the Worker
</p>
</li>
<li>
<p>
If all connected workers are overloaded or there is no worker connected,
  Server SHALL notify the client with the <a href="#err-service-unavail">Service   unavailable</a> error message.
</p>
</li>
</ul></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>event</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Name of the backend event we want to trigger.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>data</em> [<span class="monospaced">object</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        Hash with event parameters passed to the backend application.
</p>
</td>
</tr>
</table></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
<li>
<p>
<a href="#err-forbidden">Forbidden</a>
</p>
</li>
<li>
<p>
<a href="#err-service-unavail">Service unavailable</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="server-pong">Heartbeat</h3>
<div class="paragraph"><p>When the Server requested <a href="#client-heartbeat">heartbeat</a> information
then the Client responds with the <em>pong</em> message.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;pong&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;sid&quot;</span><span class="o">:</span> <span class="s2">&quot;...&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="hdlist"><div class="title">Parameters</div><table>
<tr>
<td class="hdlist1">
<em>sid</em> [<span class="monospaced">string</span>]
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
        The Client&#8217;s session identifier.
</p>
</td>
</tr>
</table></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Server sends the <em>__ping</em> message
</p>
</li>
<li>
<p>
Client MUST answer with the <em>pong</em> message as soon as possible
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="server-close">Safe closing connection</h3>
<div class="paragraph"><p>When the connected Client wants to safely close the connection, MUST
send a close message.</p></div>
<div class="listingblock">
<div class="title">Format</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;close&quot;</span><span class="o">:</span> <span class="p">{</span>
       <span class="c1">// ... custom parameters ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>All custom data parameters SHOULD be automatially passed to all
unsubscribed presence channels before closing the connection.</p></div>
<div class="ulist"><div class="title">Sequence</div><ul>
<li>
<p>
Client sends the <em>close</em> message
</p>
</li>
<li>
<p>
Server MUST terminate event loop for this particular connection.
</p>
</li>
<li>
<p>
Server MUST answer with the <a href="#client-closed"><em>__closed</em></a> message
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Possible errors</div><ul>
<li>
<p>
<a href="#err-bad-request">Bad request</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_errors">Errors</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <a href="#WR">WebRocket</a> error messages and codes are inspired by the
<a href="#HTTPCODES">HTTP status codes</a>. Here&#8217;s the full list of possible errors:</p></div>
<div class="paragraph" id="err-bad-request"><div class="title"><span class="monospaced">400</span>: <em>Bad request</em></div><p>The message sent by the client couldn&#8217;t be understood due to
malformed syntax. The client SHOULD NOT repeat the request
without the modifications.</p></div>
<div class="paragraph" id="err-unauth"><div class="title"><span class="monospaced">402</span>: <em>Unauthorized</em></div><p>Returned when invalid credentials given - user doesn&#8217;t exist
in the system or secret key is not matching the specified user.</p></div>
<div class="paragraph" id="err-forbidden"><div class="title"><span class="monospaced">403</span>: <em>Forbidden</em></div><p>The server understood the request, but is refusing to fulfill it
due to lack of user rights. The request SHOULD NOT be repeated
until authenticate for as a different user or grant current user
with required permissions.</p></div>
<div class="paragraph"><div class="title"><span class="monospaced">451</span>: <em>Invalid channel name</em></div><p>Name of the channel specified in the payload is empty or contains
invalid characters. The request SHOULD NOT be repeated without
the channel name modifications.</p></div>
<div class="paragraph" id="err-not-subscribed"><div class="title"><span class="monospaced">453</span>: <em>Not subscribed</em></div><p>Channel is not subscribed by this client, so the operation on it
can not be finished. The request SHOULD NOT be repeated.</p></div>
<div class="paragraph" id="err-channel-not-found"><div class="title"><span class="monospaced">454</span>: <em>Channel not found</em></div><p>Specified channel does not exist, so the operation on it can not
be finished. The request SHOULD NOT be repeated until the channel
will be created.</p></div>
<div class="paragraph" id="err-service-unavail"><div class="title"><span class="monospaced">503</span>: <em>Service unavailable</em></div><p>The server is currently unable to handle the request due to
a temporary overloading or unpresence of the backend application
workers. The request MAY be repeated after short time.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography"><div class="title">Bibliography</div><ul>
<li>
<p>
<a id="RFC2119"></a>[RFC2119] <a href="http://tools.ietf.org/html/rfc2119">Key words
  for use in RFCs to Indicate Requirement</a> - S. Bradner, IETF
</p>
</li>
<li>
<p>
<a id="WSP"></a>[WSP] <a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol">
  The WebSockets Protocol</a> - I. Fette, IETF
</p>
</li>
<li>
<p>
<a id="WSA"></a>[WSA] <a href="http://dev.w3.org/html5/websockets/">The WebSockets
  API</a> - I. Hickson, W3C
</p>
</li>
<li>
<p>
<a id="JSON"></a>[JSON] <a href="http://www.ietf.org/rfc/rfc4627">JavaScript Object
  Notation (JSON)</a> - D. Crockford, JSON.org
</p>
</li>
<li>
<p>
<a id="HTTPCODES"></a>[HTTPCODES] <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">
  HTTP Status Code Definitions</a> - W3.org
</p>
</li>
<li>
<p>
<a id="WR"></a>[WR] <a href="http://webrocket.io/">WebRocket&#8217;s Home Page</a> - webrocket.io
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Version 0.1<br>
Last updated 2011-12-30 15:34:02 UYST
</div>
</div>
</body>
</html>
